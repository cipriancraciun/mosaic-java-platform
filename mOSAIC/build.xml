<?xml version="1.0" encoding="UTF-8"?>

<project name="mOSAIC API build file" default="jar" basedir=".">
	<description>
		mOSAIC API build file
    </description>

	<!-- Define the environment variable -->
	<property environment="env" />

	<!-- 
    Properties in these files will override the properties defined in this file.
    -->
	<property file="build.properties" />

	<!-- Important directories and files -->
	<property name="src.dir" value="src" />
	<property name="test.dir" value="test" />
	<property name="test.output.dir" value="test-output" />
	<property name="lib.dir" value="lib" />

	<!-- Name of the JAR file that will be generated -->
	<property name="jar.all.name" value="mosaic.all.jar" />

	<!-- Build directories -->

	<!-- Auxiliary directory where all the intermediate files will be placed -->
	<property name="build.dir" location="build" />
	<property name="build.test.dir" location="build-tests" />


	<target name="init">
		<tstamp />
	</target>

	<target name="clean" depends="init" description="Delete the generated files">
		<delete dir="${build.dir}" failonerror="false" />
		<delete dir="${build.test.dir}" failonerror="false" />
		<delete dir="${test.output.dir}" failonerror="false" />
		<delete file="${jar.all.name}" failonerror="false" />
	</target>

	<target name="compile" depends="clean" description="Compiles the project">
		<mkdir dir="${build.dir}" />
		<javac destdir="${build.dir}" debug="yes" includeantruntime="true">
			<src path="${src.dir}/mosaic-core">
			</src>
			<src path="${src.dir}/mosaic-interop">
			</src>
			<src path="${src.dir}/mosaic-driver">
			</src>
			<src path="${src.dir}/mosaic-connector">
			</src>
			<classpath>
				<fileset dir="lib">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</javac>
		<copy todir="${build.dir}">
			<fileset dir="${src.dir}/mosaic-core">
				<include name="**/*.properties" />
			</fileset>
			<fileset dir="${src.dir}/mosaic-interop">
				<include name="**/*.properties" />
			</fileset>
			<fileset dir="${src.dir}/mosaic-driver">
				<include name="**/*.properties" />
			</fileset>
			<fileset dir="${src.dir}/mosaic-connector">
				<include name="**/*.properties" />
			</fileset>
			<fileset dir="${src.dir}/mosaic-cloudlet">
				<include name="**/*.properties" />
			</fileset>
		</copy>
	</target>

	<target name="compile-all" depends="clean" description="Compiles the project">
		<mkdir dir="${build.test.dir}" />
		<javac destdir="${build.test.dir}" debug="yes" includeantruntime="true">
			<src path="${src.dir}/mosaic-core">
			</src>
			<src path="${src.dir}/mosaic-interop">
			</src>
			<src path="${src.dir}/mosaic-driver">
			</src>
			<src path="${src.dir}/mosaic-connector">
			</src>
			<src path="${src.dir}/mosaic-cloudlet">
			</src>
			<src path="${test.dir}">
			</src>
			<classpath>
				<fileset dir="lib">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</javac>
		<copy todir="${build.test.dir}">
			<fileset dir="${test.dir}">
				<exclude name="**/*.java" />
				<exclude name="resources" />
			</fileset>
			<fileset dir="${basedir}">
				<include name="log4j.properties" />
			</fileset>
			<fileset dir="${test.dir}/resources">
				<include name="*.prop*" />
			</fileset>
			<fileset dir="${src.dir}/mosaic-core">
				<include name="**/*.properties" />
			</fileset>
			<fileset dir="${src.dir}/mosaic-interop">
				<include name="**/*.properties" />
			</fileset>
			<fileset dir="${src.dir}/mosaic-driver">
				<include name="**/*.properties" />
			</fileset>
			<fileset dir="${src.dir}/mosaic-connector">
				<include name="**/*.properties" />
			</fileset>
			<fileset dir="${src.dir}/mosaic-cloudlet">
				<include name="**/*.properties" />
			</fileset>
		</copy>
	</target>

	<target name="jar" depends="compile-all" description="Creates a JAR archive for the project">
		<jar destfile="${jar.all.name}" basedir="${build.test.dir}" />
	</target>

	<target name="config-tests">
		<mkdir dir="${test.output.dir}" />
		<junit>
			<test name="mosaic.core.configuration.tests.PropertyTypeConfigurationTest" todir="${test.output.dir}">
			</test>
			<classpath>
				<fileset dir="lib">
					<include name="**/*.jar" />
				</fileset>
				<fileset dir=".">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
			<formatter type="plain" usefile="true" />
		</junit>
	</target>

	<target name="driver-tests" description="Runs the driver tests. Assumes a membase store is running on localhost.">
		<mkdir dir="${test.output.dir}" />
		<junit>
			<batchtest fork="yes" todir="${test.output.dir}">
				<fileset dir="${test.dir}">
					<include name="mosaic/driver/**/*Test.java" />
					<exclude name="mosaic/driver/**/Redis*Test.java" />
				</fileset>
				<formatter type="plain" usefile="true" />
			</batchtest>
			<classpath>
				<fileset dir="lib">
					<include name="**/*.jar" />
				</fileset>
				<fileset dir=".">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</junit>
	</target>

	<target name="redis-tests" description="Runs the Redis driver tests. Assumes a Redis store is running on localhost.">
		<mkdir dir="${test.output.dir}" />
		<junit fork="false">
			<test name="mosaic.driver.kvstore.tests.RedisDriverTest" todir="${test.output.dir}">
			</test>

			<formatter type="plain" usefile="true" />
			<classpath>
				<fileset dir="lib">
					<include name="**/*.jar" />
				</fileset>
				<fileset dir=".">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</junit>
	</target>

	<target name="conn-tests" description="Runs the connector tests. Assumes a membase store  and a RabbitMQ server is running on localhost.">
		<mkdir dir="${test.output.dir}" />
		<sequential>
			<junit fork="false">
				<test name="mosaic.connector.kvstore.tests.MemcachedConnectorTest" todir="${test.output.dir}">
				</test>
				<formatter type="plain" usefile="true" />
				<classpath>
					<fileset dir="lib">
						<include name="**/*.jar" />
					</fileset>
					<fileset dir=".">
						<include name="**/*.jar" />
					</fileset>
				</classpath>
			</junit>
			<junit fork="false">
				<test name="mosaic.connector.kvstore.tests.KeyValueConnectorTest" todir="${test.output.dir}">
				</test>
				<formatter type="plain" usefile="true" />
				<classpath>
					<fileset dir="lib">
						<include name="**/*.jar" />
					</fileset>
					<fileset dir=".">
						<include name="**/*.jar" />
					</fileset>
				</classpath>
			</junit>
		</sequential>
	</target>

	<target name="debug-conn">
		<java classname="mosaic.connector.kvstore.tests.KeyValueConnectorTest" fork="true">
			<classpath>
				<fileset dir="lib">
					<include name="**/*.jar" />
				</fileset>
				<fileset dir=".">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="hello-cloudlet" description="Runs the logging cloudlet. Assumes a membase store  and a RabbitMQ server is running on localhost.">
		<mkdir dir="${test.output.dir}" />
		<java classname="mosaic.cloudlet.tests.CloudletDummyContainerTest" fork="true" output="${test.output.dir}/hello-cloudlet.test">
			<arg value="hello-cloudlet.prop" />
			<classpath>
				<fileset dir="lib">
					<include name="**/*.jar" />
				</fileset>
				<fileset dir=".">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="start-amqp-driver" description="Starts an amqp driver">
		<java classname="mosaic.cloudlet.tests.AmqpDriverStarter" fork="true" output="${test.output.dir}/amqp-driver.out">
			<arg value="amqp-driver.prop" />
			<classpath>
				<fileset dir="lib">
					<include name="**/*.jar" />
				</fileset>
				<fileset dir=".">
					<include name="mosaic*.jar" />
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="start-memcached-driver" description="Starts a memcached driver">
		<java classname="mosaic.cloudlet.tests.MemcachedDriverStarter" fork="true" output="${test.output.dir}/memcached-driver.out">
			<arg value="memcached-driver.prop" />
			<classpath>
				<fileset dir="lib">
					<include name="**/*.jar" />
				</fileset>
				<fileset dir=".">
					<include name="mosaic*.jar" />
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="queue-cloudlet" description="Runs the logging cloudlet. Assumes a membase store  and a RabbitMQ server is running on localhost.">
		<mkdir dir="${test.output.dir}" />
		<parallel>
			<antcall target="start-amqp-driver" />
			<java classname="mosaic.cloudlet.tests.CloudletDummyContainerTest" fork="true" output="${test.output.dir}/publisher-cloudlet.out">
				<arg value="publisher-cloudlet.prop" />
				<classpath>
					<fileset dir="lib">
						<include name="**/*.jar" />
					</fileset>
					<fileset dir=".">
						<include name="mosaic*.jar" />
					</fileset>
				</classpath>
			</java>
			<java classname="mosaic.cloudlet.tests.CloudletDummyContainerTest" fork="true" output="${test.output.dir}/consumer-cloudlet.out">
				<arg value="consumer-cloudlet.prop" />
				<classpath>
					<fileset dir="lib">
						<include name="**/*.jar" />
					</fileset>
					<fileset dir=".">
						<include name="mosaic*.jar" />
					</fileset>
				</classpath>
			</java>
		</parallel>
	</target>

	<target name="logging-cloudlet" description="Runs the logging cloudlet. Assumes a membase store  and a RabbitMQ server is running on localhost.">
		<mkdir dir="${test.output.dir}" />
		<parallel>
			<antcall target="start-amqp-driver" />
			<!--<antcall target="start-memcached-driver" />-->
			<java classname="mosaic.cloudlet.tests.CloudletDummyContainerTest" fork="true" output="${test.output.dir}/logging-cloudlet.out">
				<arg value="simple-logging-cloudlet.prop" />
				<classpath>
					<fileset dir="lib">
						<include name="**/*.jar" />
					</fileset>
					<fileset dir=".">
						<include name="mosaic*.jar" />
					</fileset>
				</classpath>
			</java>
			<java classname="mosaic.cloudlet.tests.CloudletDummyContainerTest" fork="true" output="${test.output.dir}/user-cloudlet.out">
				<arg value="user-cloudlet.prop" />
				<classpath>
					<fileset dir="lib">
						<include name="**/*.jar" />
					</fileset>
					<fileset dir=".">
						<include name="mosaic*.jar" />
					</fileset>
				</classpath>
			</java>
		</parallel>
	</target>

	<target name="amqp-idl" description="Generates classes for amqp protocol">
		<java jar="lib/avro-tools-1.5.0.jar" fork="true">
			<arg value="idl" />
			<arg value="protocol/amqp.avdl" />
			<arg value="protocol/amqp.avpr" />
			<classpath>
				<fileset dir="lib">
					<include name="avro-tools*.jar" />
					<include name="slf4j*.jar" />
				</fileset>
			</classpath>
		</java>
		<java jar="lib/avro-tools-gen.jar" fork="true">
			<arg value="compile" />
			<arg value="protocol" />
			<arg value="protocol/amqp.avpr" />
			<arg value="protocol/src" />
			<classpath>
				<fileset dir="lib">
					<include name="avro-tools-gen.jar" />
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="kv-idl" description="Generates classes for KEY-VALUE stores and memcached protocol">
		<java jar="lib/avro-tools-1.5.0.jar" fork="true">
			<arg value="idl" />
			<arg value="protocol/memcached.avdl" />
			<arg value="protocol/memcached.avpr" />
			<classpath>
				<fileset dir="lib">
					<include name="avro-tools*.jar" />
					<include name="slf4j*.jar" />
				</fileset>
			</classpath>
		</java>
		<java jar="lib/avro-tools-gen.jar" fork="true">
			<arg value="compile" />
			<arg value="protocol" />
			<arg value="protocol/memcached.avpr" />
			<arg value="protocol/src" />
			<classpath>
				<fileset dir="lib">
					<include name="avro-tools-gen.jar" />
				</fileset>
			</classpath>
		</java>
	</target>

</project>
